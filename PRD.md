# Notion2JIRA 同步系统 PRD

## 1. 项目背景与目标

### 1.1 背景描述
EBG 商用产品团队当前使用双系统管理产研流程：
- **需求管理**：Notion Database（需求收集、评估、整理）
- **开发管理**：RDJIRA 内网系统（任务分配、开发跟踪）
- **痛点**：两系统数据孤岛，需大量人工复制粘贴工作，数据不同步

### 1.2 项目目标
- **主要目标**：实现 Notion ↔ JIRA 双向自动同步
- **效率提升**：减少 80% 的人工数据录入工作
- **数据一致性**：确保关键字段准确同步，双向数据保持一致
- **可监控性**：提供同步状态监控和错误追踪

### 1.3 技术约束
- **Notion**：公网云服务，支持 webhook 和 API
- **RDJIRA**：内网服务（http://rdjira.tp-link.com），JIRA 7.3.0
- **网络环境**：公网代理服务器（https://notion2jira.tp-link.com）作为中转
- **服务器环境**：CentOS 7，已配置域名和SSL证书
- **权限范围**：SMBNET 项目读写权限
- **开发资源**：产研团队自行开发维护

## 2. 核心需求分析

### 2.1 用户故事

#### Notion → JIRA 同步
**作为** 产品经理  
**我希望** 在 Notion 中通过多种方式触发同步（点击按钮、勾选复选框等）  
**以便** 自动在 JIRA 中创建对应的开发任务，并且Notion页面状态自动更新为"已输入"，JIRA链接自动填入

#### JIRA → Notion 反向同步
**作为** 开发人员  
**我希望** 在 JIRA 中更新任务状态后  
**以便** Notion 中对应的需求状态能够自动同步更新，保持两边数据一致

**作为** 项目管理员  
**我希望** 能够监控双向同步状态和错误日志  
**以便** 及时发现和解决同步问题

#### 系统管理员
**作为** 系统管理员  
**我希望** 系统具备完善的监控和调试功能  
**以便** 快速定位和解决同步问题，确保系统稳定运行

### 2.2 功能需求清单

#### 核心功能（必须实现）
| 功能ID | 功能名称 | 优先级 | 描述 | 验收标准 | 状态 |
|--------|----------|--------|------|----------|------|
| F001 | Notion → JIRA 同步 | P0 | 通过多种方式触发需求同步到JIRA | 触发后5分钟内在JIRA中创建对应Issue | ✅ 已完成 |
| F002 | 智能字段映射转换 | P0 | 将Notion字段准确映射到JIRA字段 | 支持32种字段类型，双重存储结构 | ✅ 已完成 |
| F003 | 重复检测机制 | P0 | 避免重复创建JIRA Issue | 同一Notion页面不会创建多个JIRA Issue | ⏳ 进行中 |
| F004 | Notion状态回写 | P0 | 同步完成后更新Notion页面状态和链接 | 状态改为"已输入"，JIRA链接写入"JIRA CARD"字段 | ⏳ 进行中 |
| F005 | JIRA → Notion 反向同步 | P0 | JIRA状态变更同步回Notion | 定期检测JIRA变更，更新对应Notion页面 | 📋 待开始 |
| F006 | 增量同步机制 | P0 | 只同步有变更的JIRA Issue | 基于时间戳的增量检测，避免重复处理 | 📋 待开始 |
| F007 | 灵活同步触发 | P0 | 支持多种同步触发方式 | Button Property、Checkbox、默认策略 | ✅ 已完成 |
| F008 | 系统监控和调试 | P0 | 完善的监控和调试功能 | 健康检查、统计信息、队列状态接口 | ✅ 已完成 |

#### 扩展功能（后续版本）
| 功能ID | 功能名称 | 优先级 | 描述 | 状态 |
|--------|----------|--------|------|------|
| F009 | 同步状态监控面板 | P1 | Web界面监控同步状态 | 📋 待开始 |
| F010 | 批量同步功能 | P2 | 支持批量选择多个需求同步 | 📋 待开始 |
| F011 | 冲突解决机制 | P2 | 处理双向同步的数据冲突 | 📋 待开始 |
| F012 | 多项目支持 | P2 | 支持多个JIRA项目同步 | 📋 待开始 |

### 2.3 字段映射规范

基于字段映射分析结果，确定以下映射关系：

| 字段用途 | Notion字段名 | Notion字段类型 | JIRA字段名 | 映射规则 |
|----------|-------------|---------------|-----------|----------|
| 需求标题 | 功能 Name | title | Summary | 直接映射 |
| 需求状态 | Status | status | Status | 状态映射表转换 |
| 优先级 | 优先级 P | select | Priority | 优先级映射表转换 |
| 需求描述 | 功能说明 Desc | rich_text | Description | 组合字段（见下方） |
| AI整理 | 需求整理 | rich_text | Description | 组合到Description |
| 需求链接 | url | url | Description | 组合到Description |
| 分配人员 | 需求录入 | people | Assignee | 邮箱匹配转换 |
| 实现版本 | 关联项目 | relation | fixVersions | 版本名称匹配 |
| JIRA链接 | JIRA Card | url | - | 回写字段（同步后更新） |

#### Description 字段组合规则
```
## 需求说明
{功能说明 Desc 内容}

## 需求整理(AI)
{需求整理 内容}

## 原始需求链接
{Notion页面URL}
```

### 2.4 状态映射表

| Notion状态 | JIRA状态 | 说明 |
|-----------|----------|------|
| 初始反馈 OR | 待可行性评估 | 新需求待评估 |
| 待评估 UR | 待可行性评估 | 等待技术评估 |
| 待输入 WI | TODO | 准备开发 |
| 同步中 SYNC | TODO | 同步过程中 |
| 已输入 JIRA | TODO | 已同步到JIRA |
| DEVING | 开发中 | 开发进行中 |
| Testing | Testing（测试） | 测试阶段 |
| 已发布 DONE | 完成 | 开发完成 |

### 2.5 优先级映射表

| Notion优先级 | JIRA优先级 | 说明 |
|-------------|-----------|------|
| 高 High | Highest | 最高优先级 |
| 中 Medium | Medium | 中等优先级 |
| 低 Low | Low | 低优先级 |
| 无 None | Lowest | 最低优先级 |

### 2.6 详细操作流程

#### 2.6.1 Notion → JIRA 同步流程
1. **用户操作**: 用户通过以下方式之一触发同步：
   - 点击 Notion 页面中的 Button Property（推荐）
   - 勾选同步复选框（sync2jira、同步到JIRA、Sync to JIRA）
   - 默认策略：任何页面更新都触发同步
2. **触发同步**: 系统接收到webhook事件，开始同步处理
3. **字段解析**: 使用双重存储结构解析32种字段类型
4. **字段映射**: 将Notion字段按照映射规则转换为JIRA字段
5. **重复检测**: 检查是否已存在对应的JIRA Issue
6. **创建Issue**: 在JIRA中创建对应的Issue
7. **状态回写**: 
   - 将Notion页面的Status字段更新为"已输入"
   - 将JIRA Issue链接写入"JIRA CARD"字段
8. **完成确认**: 用户可以看到状态变更和JIRA链接

#### 2.6.2 JIRA → Notion 反向同步流程
1. **定期检测**: 系统定期（如每5分钟）检查JIRA Issue更新
2. **增量查询**: 按照最后更改时间降序查询JIRA Issue
3. **关联检查**: 检查Issue是否有对应的Notion页面
   - 有对应页面：进行同步更新
   - 无对应页面：说明是JIRA研发需求，跳过同步
4. **状态同步**: 将JIRA状态变更同步到Notion对应字段
5. **时间戳更新**: 记录最新处理的时间戳，下次只处理该时间戳之后的Issue

#### 2.6.3 冲突处理策略
- **同时修改**: 如果Notion和JIRA同时被修改，以JIRA为准
- **循环防护**: 避免双向同步造成的无限循环更新
- **错误恢复**: 同步失败时记录错误，支持手动重试

## 3. 非功能需求

### 3.1 性能要求
- **同步延迟**：点击同步按钮后5分钟内完成
- **并发处理**：支持同时处理10个同步请求
- **系统可用性**：99% 服务可用性（工作时间）

### 3.2 安全要求
- **API密钥管理**：安全存储JIRA认证信息
- **访问控制**：仅授权用户可触发同步
- **数据传输**：HTTPS加密传输
- **日志记录**：完整的操作审计日志

### 3.3 可维护性要求
- **错误监控**：实时错误告警机制
- **日志管理**：结构化日志，便于问题排查
- **配置管理**：字段映射可配置化
- **文档完整**：API文档和运维文档

## 4. 技术选型

### 4.1 架构选择
- **部署模式**：公网代理 + 内网服务
- **消息队列**：Redis（轻量级，易部署）
- **数据存储**：文件配置 + Redis缓存
- **监控方案**：日志文件 + 简单Web界面

### 4.2 技术栈
- **公网代理**：Node.js + Express
- **内网服务**：Python + Flask/FastAPI
- **消息队列**：Redis
- **部署环境**：Docker容器化部署

## 5. 项目里程碑

### 5.1 MVP版本（v1.0）
**目标**：实现基础的Notion → JIRA单向同步
**时间**：4周
**核心功能**：
- Notion webhook接收
- 字段映射转换
- JIRA Issue创建
- 基础错误处理

### 5.2 增强版本（v1.1）
**目标**：完善监控和错误处理
**时间**：2周
**新增功能**：
- 同步状态监控
- 详细错误日志
- 手动重试机制

### 5.3 完整版本（v2.0）
**目标**：双向同步和高级功能
**时间**：4周
**新增功能**：
- JIRA → Notion反向同步
- 批量同步功能
- 高级配置管理

## 6. 风险评估

### 6.1 技术风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| JIRA API限制 | 高 | 中 | 提前测试API限制，实现限流控制 |
| 网络连接不稳定 | 中 | 中 | 实现重试机制和错误恢复 |
| 字段映射复杂性 | 中 | 高 | 详细测试各种字段组合 |

### 6.2 业务风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 用户接受度低 | 高 | 低 | 充分的用户培训和文档 |
| 数据同步错误 | 高 | 中 | 完善的测试和回滚机制 |
| 维护成本高 | 中 | 中 | 简化架构，完善文档 |

## 7. 成功指标

### 7.1 定量指标
- **同步成功率**：≥ 95%
- **同步延迟**：≤ 5分钟
- **用户使用率**：≥ 80%的需求通过同步创建
- **错误率**：≤ 5%

### 7.2 定性指标
- 用户反馈满意度
- 减少手工操作时间
- 数据一致性改善
- 工作流程优化效果